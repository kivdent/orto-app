<?php


namespace common\modules\schedule\models;

use common\modules\catalogs\models\NoticeResult;
use common\modules\employee\models\Employee;
use common\modules\patient\models\Patient;
use common\modules\userInterface\models\UserInterface;
use Exception;
use yii\behaviors\TimestampBehavior;
use yii\db\Expression;

/**
 * @property Patient $patient
 * @property  AppointmentsDay $appointments_day
 * @property  AppointmentContent $appointmentContent
 * @property-read Employee $employee
 * @property-read string $employeeName
 * @property-read string $info
 * @property-read string[] $appointmentResultLabels
 * @property-read string $appointmentResultLabel
 * @property-read int $unixDate
 * @property-read string $date
 * @property-read int $appointmentDurationSeconds
 * @property-read null|mixed $durationSeconds
 * @property  NoticeResult $noticeResult
 */
class Appointment extends \common\models\Appointment
{
    const SMS_SENT = 7;

    const STATUS_ACTIVE = 'active';
    const STATUS_CANCEL = 'cancel';

    const PRESENCE_STATUS_APPEARED = 1;
    const PRESENCE_STATUS_NOT_APPEARED = 0;
    const APPOINTMENT_RESULT_VISIT = 'visit';
    const APPOINTMENT_RESULT_NOT_VISIT = 'not_visit';
    const APPOINTMENT_RESULT_REASSIGNMENT = 'reassignment';

    public $result;
    public $patientTtreatmentPlansIds;
    public $patientDoctorsIds;


    public static $status_list = [self::SMS_SENT => 'Отправлено смс'];
    /**
     * @var bool|true
     */
    public $initialDateFlag;
    public $appointment_result;
    /**
     * @var string
     */
    public $employeePositionName;
    /**
     * @var int
     */
    public $patientTreamentPlansCount;
    /**
     * @var int
     */
    public $countDoctors;



    public function behaviors()
    {
        return [
            [
                'class' => TimestampBehavior::className(),
                'value' => new Expression('NOW()'),
            ]
        ];
    }

    public function beforeSave($insert)
    {

        parent::beforeSave($insert); // TODO: Change the autogenerated stub


        if ($this->isNewRecord) {
            $this->status = self::STATUS_ACTIVE;
            $this->employee_id = UserInterface::getEmployeeId();
        } else {
            if (!$this->employee_id) $this->employee_id = UserInterface::getEmployeeId();
        }

        if ($this->status == self::STATUS_ACTIVE && $this->hasCrossTime()) {
            // UserInterface::getVar($this->status);
            \Yii::$app->session->setFlash('danger', 'Время занято');
            return false;
        }
        return true;

    }

    public static function getAppointmentsForAppointmentDay(AppointmentsDay $appointment_day)
    {
        return self::find()->where(['dayPR' => $appointment_day->id, 'status' => self::STATUS_ACTIVE])->orderBy('NachNaz')->all();
    }

    public static function GetNoticeList()
    {
        return NoticeResult::getNoticeResultList();
    }

    public static function getAppointmentsForTimeList(AppointmentsDay $appointment_day)
    {

        return self::find()->where(['dayPR' => $appointment_day->id, 'status' => self::STATUS_ACTIVE])->orderBy('NachNaz')->all();

    }

    public static function getSortedByDate($patient_id)
    {
        return self::find()
            ->where(['PatID' => $patient_id])
            ->leftJoin('daypr', 'nazn.dayPR=daypr.id')
            ->orderBy('daypr.date DESC')
            ->all();
    }

    public function getPatient()
    {
        return $this->hasOne(Patient::className(), ['id' => 'PatID']);
    }

    public function getAppointments_day()
    {
        return $this->hasOne(AppointmentsDay::className(), ['id' => 'dayPR']);
    }

    public function getAppointmentContent()
    {
        return $this->hasOne(AppointmentContent::class, ['id' => 'SoderzhNaz']);
    }

    public function attributeLabels()
    {
        return [
            'Id' => 'ID',
            'PatID' => 'Пациент',
            'dayPR' => 'День приёма',
            'NachNaz' => 'Начало приёма',
            'OkonchNaz' => 'Окончание приёма',
            'SoderzhNaz' => 'Содержание приёма',
            'RezObzv' => 'Результат обзвона',
            'Yavka' => 'Явка',
            'NachPr' => 'Фактическое начало приёма',
            'OkonchPr' => 'Фактическое окончание приёма',
            'status' => 'Статус',
            'appointment_content' => 'Содержание приёма',
        ];
    }

    public function AppointmentPresence()
    {
        return ($this->NachPr == "00:00:00" and $this->Yavka == self::PRESENCE_STATUS_APPEARED);
    }

    public function AppointmentStarted()
    {
        return ($this->NachPr <> "00:00:00" and $this->OkonchPr == "00:00:00");
    }

    public function AppointmentStopped()
    {
        return ($this->NachPr <> "00:00:00" and $this->OkonchPr <> "00:00:00");

    }

    public function getNoticeResult()
    {
        return $this->hasOne(NoticeResult::class, ['id' => 'RezObzv']);
    }

    public function getEmployee()
    {
        return $this->hasOne(Employee::class, ['id' => 'employee_id']);
    }

    public function getEmployeeName()
    {
        return $this->employee ? $this->employee->fullName : 'Не указан';
    }

    public function getInfo()
    {
        $string = '';
        $string .= $this->created_at ? 'созд. ' . UserInterface::getFormatedDate($this->created_at) . ' ' : '';
        $string .= $this->updated_at ? 'изм.' . UserInterface::getFormatedDate($this->updated_at) . ' ' : '';
        $string .= $this->employee ? $this->employeeName : '';
        return $string;
    }

    public static function getRowClass($appoitment)
    {
        $class = 'bg-info';
        if ($appoitment->status === Appointment::STATUS_CANCEL) {
            $class = 'bg-danger';
        } elseif ((strtotime(UserInterface::getFormatedDate($appoitment->appointments_day->date))) <= (int)strtotime('now')) {
            $class = 'bg-warning';
        }
        return $class;
    }

    function hasCrossTime()
    {
        $start_time = strtotime($this->appointments_day->date . ' ' . $this->NachNaz);
        $end_time = strtotime($this->appointments_day->date . ' ' . $this->OkonchNaz);

        $duration = 60;


        foreach ($this->appointments_day->appointments as $appointment) {


            $appointment_start_time = strtotime($this->appointments_day->date . ' ' . $appointment->NachNaz);
            $appointment_end_time = strtotime($this->appointments_day->date . ' ' . $appointment->OkonchNaz);

            for ($time = $start_time; $time <= $end_time; $time += $duration) {
                if ($this->Id !== $appointment->Id and $appointment->status == self::STATUS_ACTIVE) {
                    if ($appointment_start_time === $time && $appointment_start_time !== $end_time && $appointment->status == self::STATUS_ACTIVE) {
                        //throw new Exception('Время занято. '.$this->Id.' -'.$appointment->Id.'-' . $time . '-' . strtotime($this->appointments_day->date . ' ' . $appointment->NachNaz) . '-' . strtotime($this->appointments_day->date . ' ' . $appointment->OkonchNaz));
                        return true;
                    }
                    if ($appointment_end_time === $time && $appointment_end_time !== $start_time && $appointment->status == self::STATUS_ACTIVE) {
                        //throw new Exception('Время занято. ' . $time . '-' . strtotime($this->appointments_day->date . ' ' . $appointment->NachNaz) . '-' . strtotime($this->appointments_day->date . ' ' . $appointment->OkonchNaz));
                        return true;
                    }

                    if ($appointment_start_time == $start_time) return true;
                    if ($start_time < $appointment_start_time && $end_time > $appointment_start_time) return true;
                    if ($start_time < $appointment_end_time && $end_time > $appointment_end_time) return true;
                    if ($start_time > $appointment_start_time && $end_time < $appointment_end_time) return true;
                    if ($start_time < $appointment_start_time && $end_time > $appointment_end_time) return true;

                }
            }
        }


        return false;
    }

    /**
     * @return true|false
     */
    public function isInitialOnDate()
    {
        $initial = true;
        $appointment = Appointment::find()
            ->where(['PatID' => $this->PatID])
            ->andWhere(['<>', 'NachPr', '00:00:00'])
            ->andWhere(['<', 'daypr.date', $this->appointments_day->date])
            ->leftJoin('daypr', 'daypr.id=nazn.dayPR')
            ->orderBy('daypr.date DESC')
            ->all();
        if (count($appointment) !== 0) $initial = false;

        return $initial;
    }

    public function setInitialDateFlag()
    {
        $this->initialDateFlag = $this->isInitialOnDate();
    }

    public function setStatisticsParams()
    {
//        if (strtotime($this->unixDate) <= date('U') and $this->Yavka == 1 and $this->NachPr != '00:00:00') {
//            $this->appointment_result = self::APPOINTMENT_RESULT_VISIT;
//        } elseif (strtotime($this->unixDate) <= date('U') and ($this->Yavka == 0 or ($this->Yavka == 1 and $this->NachPr == '00:00:00'))) {
//            $this->appointment_result = self::APPOINTMENT_RESULT_NOT_VISIT;
//        }
        //Статус назначения
        if ($this->unixDate <= date('U')) {
            if ($this->status == self::STATUS_ACTIVE and $this->NachPr != '00:00:00') {
                $this->appointment_result = self::APPOINTMENT_RESULT_VISIT;
            } elseif ($this->patient->totalRealAppointments >= 1) {
                $this->appointment_result = self::APPOINTMENT_RESULT_REASSIGNMENT;
            } else {
                $this->appointment_result = self::APPOINTMENT_RESULT_NOT_VISIT;
            }
        }
        //Специальность врача
        $this->employeePositionName = $this->appointments_day->doctor->positionName;
        //Количесвто планов лечения
        $this->patientTreamentPlansCount = $this->patient->treatmentPlansCount;
        //Количесво докторов с выписаннами оплатами
        $this->countDoctors = $this->patient->countDoctors;
    }

    /**
     * @return string[]
     */
    public function getAppointmentResultLabels(): array
    {
        return [
            self::APPOINTMENT_RESULT_VISIT => 'Явка',
            self::APPOINTMENT_RESULT_NOT_VISIT => 'Не явка',
            self::APPOINTMENT_RESULT_REASSIGNMENT => 'Переназначен',
        ];
    }

    /**
     * @return string
     */
    public function getAppointmentResultLabel(): string
    {
        return isset($this->appointment_result) ? $this->getAppointmentResultLabels()[$this->appointment_result] : 'Не известно';
    }

    /**
     * @return int
     */

    public function getUnixDate(): int
    {

        return strtotime($this->date . ' ' . $this->NachNaz);
    }

    /**
     * @return mixed|null
     */
    public function getDurationSeconds()
    {
        $start = strtotime($this->date . ' ' . $this->NachPr);
        $end = strtotime($this->date . ' ' . $this->OkonchPr);

        $durationSeconds = $end - $start;
        return $durationSeconds;
    }

    /**
     * @return int
     */
    public function getAppointmentDurationSeconds(): int
    {

        $start = strtotime($this->date . ' ' . $this->NachNaz);
        $end = strtotime($this->date . ' ' . $this->OkonchNaz);

        $durationSeconds = $end - $start;
        return $durationSeconds;
    }

    /**
     * @return string
     */
    public function getDate(): string
    {
        return date('d.m.Y', $this->appointments_day->unixDate);
    }
}